<!doctype html>
ctx.fillStyle='#94a3b8'; ctx.font='14px monospace'; ctx.fillText('Score: '+score,10,16);
}


function step(){ frame++; if(frame % Math.max(1, Math.floor(60/speed)) !== 0) return; const head = {x:snake[0].x+dir.x, y:snake[0].y+dir.y};
// wall wrap
if(head.x < 0) head.x = cols-1; if(head.x >= cols) head.x=0; if(head.y<0) head.y=rows-1; if(head.y>=rows) head.y=0;
// collision
if(snake.some(s=>s.x===head.x && s.y===head.y)){ gameOver=true; showToast('Game Over'); scores.snake++; saveScores(scores); return; }
snake.unshift(head);
if(head.x===food.x && head.y===food.y){ score+=1; food=spawnFood(); if(score % 4 === 0) speed = Math.min(18, speed+1); }
else snake.pop();
}


function loop(){ if(!gameOver) step(); draw(); if(!gameOver) requestAnimationFrame(loop); else draw(); }


function keyHandler(e){ const m = {ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0}}; if(m[e.key]){ const nd = m[e.key]; // prevent reverse
if(snake.length>1 && snake[0].x+nd.x === snake[1].x && snake[0].y+nd.y === snake[1].y) return; dir = nd; }
if(e.key === 'Escape') mountMenu(); }


// Controls
const resetBtn = document.createElement('button'); resetBtn.className='btn secondary'; resetBtn.textContent='Restart'; resetBtn.addEventListener('click', ()=>{ reset(); if(!gameOver){ /* continue */ } else { gameOver=false; loop(); } });
container.appendChild(canvas); container.appendChild(document.createElement('div')).style.height='8px'; container.appendChild(resetBtn); playArea.appendChild(container);


// start
reset(); window.addEventListener('keydown', keyHandler); loop();


// cleanup when switching
container._cleanup = ()=>{ window.removeEventListener('keydown', keyHandler); };
}


// Mount helpers
function mountMenu(){ // call cleanup if present
const prev = playArea.firstChild; if(prev && prev._cleanup) prev._cleanup(); mountWelcome(); }


function mountGame(key){ // cleanup
const prev = playArea.firstChild; if(prev && prev._cleanup) prev._cleanup(); if(key==='ttt') mountTTT(); if(key==='mem') mountMemory(); if(key==='snake') mountSnake(); }


// Wire buttons
elAll('.game-btn').forEach(b=> b.addEventListener('click', ()=>{ const g = b.dataset.game; mountGame(g); }));
el('#resetAll').addEventListener('click', ()=>{ if(confirm('Reset all saved scores?')){ scores = {...defaultScores}; saveScores(scores); showToast('Scores reset'); } });
el('#randomBtn').addEventListener('click', ()=>{ const opts=['ttt','mem','snake']; const pick = opts[Math.floor(Math.random()*opts.length)]; mountGame(pick); showToast('Loading '+pick); });


// Keyboard: Esc to menu
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') mountMenu(); });


// Accessibility: prefers-reduced-motion -> reduce animations
if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){ document.querySelectorAll('.game-btn').forEach(n=>n.style.transition='none'); }


// Ensure we save scores on page unload
window.addEventListener('beforeunload', ()=> saveScores(scores));


// Initial small animation
setTimeout(()=> document.querySelectorAll('.game-btn').forEach((b,i)=> b.style.transform='translateY(0)'),120);
</script>
</body>
</html>